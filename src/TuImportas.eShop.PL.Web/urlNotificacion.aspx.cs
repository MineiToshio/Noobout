using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using SPE.Api;
using System.Configuration;
using System.Xml;
using TuImportas.eShop.BL.BE;
using TuImportas.eShop.BL.BC;

namespace TuImportas.eShop.PL.Web
{
    public partial class urlNotificacion : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!Page.IsPostBack)
            {
                string postvariable;

                if (Request.HttpMethod == "Post")
                    postvariable = Request.Params["data"];
                else
                    return;

                string getvariable = Request.QueryString["data"];
                //postvariable = "1DC5B7411ABDF3B5325A31EB31917C75C30A1D08E91620D5250C29BB4A926C2020C9DDF63F295AC2426D98DE74DFD725FB0E364963F760F1FD13F8F3B9178AADFFAEE256EDC4BFB571A9D7024834B7B2EDDEF2DBA4C2F3B6EC8339B10144C4BEBE15E8C4C9699321D1F89FEAE4E853845A7244BF667EFB4B3B77B320D2BE0C9D5D45EDC7AD6DBFF83F642607E3A7D07D08EB91A83894883E551F8C7ED55401AF3CAEC19ECFBABB66F5B0AC67CA6D7027EF5A62FC823998B700F53E42DD328B4D90C1FD223D657780F0BD9A9B7A8C80170203D305B372C744718A88E3AD3EBCEACD86BC4FA6CC90905D45EDC7AD6DBFF8BA0E12D31C6597F33ED693322A4E7FF77C52AC8D82FAC266449C5574F597356F5D45EDC7AD6DBFF851606332BEC49ADB45F4C0A0E3167788700A8DDBF3341A3B5D45EDC7AD6DBFF84FABB74F4ACA4AF72B985E36D2A303A82685A693E11017E522A91BEA94442A528FBD0FB2EA165C073B2903C482D5B053B88E048D411009A5CC3F72500F9C7E5B3D476404FDE3D36AE089F48C756171F7C8DBCF4E33322C3F3FAC41C9560730C8C48621303247891FBF25F8FDED6FC0E7E2F0F9068F8980C924DA540F160ED6CD224AC1E7527FA0453029A4638678301550E47BEE25B3DE39CC6A3D4139E091F1EDDEF2DBA4C2F3B6838A3AA2D482D31631A815A3FF2F0729C2F0B873DE058BA196F634E708341B4DC971B612658964F823CCDFD071B26D172CB69E2D7929C2E416619F038496BC5DB88E048D411009A5E22889A6ACAAC69461E3323E87DA1EB3F0885BA8BCF4C72C3ED0611827ABBE61502BF7EAD3EBE6F94526D2FECD4DCBDDC552205DBDC685669CB9F88AC7F123D57B8D8F938A296534EAE387604CEF5A6540EEF97BEC456F7D15D8B7B0DBE171E14FC2365812122DB324A1EAC41B39E4C60DE6DE80F98B366223D53C1057C1172E302BA3491641EF187AAE94C7E1CE577DBA8FF3611D8883888313ADE44158C0B6111BC948608714D28BF4BAF9E65D208FBA8FF3611D888388151F97C606E51B6540EB9C15E8F4A19704A53A4B4D1AA2068D99F053A5D46C15006FDE036EC41C8B35D37D4332A734A70F84D3C622B8440F45F4C0A0E3167788697224776A510762095FC3143678724D017CCE2117D55786444DBF2AA17EC50EEE2116EC11F0ECE630BF82089FF5D1994E9AE555776C56D13A2F54438FE50E91444DBF2AA17EC50E5D45EDC7AD6DBFF8050F4AEE1AB9A78FFCDBA01C557C007DA9DF51D9A4F16831C82EF529AF85431B8439C444FF24AC10E641C6894E0C452E2064C2DC89CBDD235D45EDC7AD6DBFF86414D6FEC9755C31CC3029BF991D60353FAC41C9560730C86414D6FEC9755C31CC3029BF991D60351ED79357B7ABD200D8410B135283F60A18BA88021D4F8418BD0B20C0F8E2F7DBC7D33756300EE0E023CA578396445253D8410B135283F60A314D106F788905EEEC86AF6BC259EC67ECCFAE858272241C5D45EDC7AD6DBFF8B97763A96FF7986A427D767E61F03B32F704E2D096A59F115815CFA497A37DC08A21EA0847349AA5CD5191D0560D704E149A83C8D6ACD3C3314D106F788905EEA2E365076A9071AE330FA8D842F07E24B0F9356D2B9348FA268EC61CE1E17F0C7254EBC60B4B5CE5ADC567597C2C1106B93C67D3AC6E4CCBB90040052EE3614AF2EB781144EDAD0C3EB7A9868BBFD46F80061862F8A1DB2C78B3A9923C70EFEBB9A81CC7BBF4D0B3E8B39C0EBDC175AEBADB2B627837B53AE9FAF648DF16B692E43AF8F3A3EBCCC6A202D40AFD5A7963D2DE1DB98C11B3BDEB2FE27CB5F3AEDDD69961A877CD7A2CE8B39C0EBDC175AEECBB1ECED2DBCECB48F6FC1CABB0FCF8E06491E09526558D626FF343D477EF975D45EDC7AD6DBFF85358A1BCD7B7F1D9147C772056CC5AF5C13983E5AE1CA7F0E968106106498DD377E618BD8F58FECC747C339298DA92531BCEC14851864BBA7B333222978FC80069AB3337F201A44FEBA836888EA5F13DC971B612658964F8ECBB1ECED2DBCECBC2CF1C9A421A1839B5D114429145440F747C90E250CE5FAB0FFD1344F3CF9BF25760A4614895040E5D45EDC7AD6DBFF80FFD1344F3CF9BF2370904A05F4DFFFC9E3599DC7A413D0264E08A67E046F38B4C4A813BA009D835CC7BCE7D5EDF3D83747C339298DA9253C601DB289DEEFA140628E222B0C84AF6C275C89754560138C388E243C550242AC46D42A10E0B45942F9AA805A315C3265113FF72AFDE98DF80E4692554BED69375D4F25D09733E247D6DD15BD19C97F6CC0CE83CDFB0EA7C75B726148561E92D49B493812EC3DDD3F622976D8CA212B3330EE7D9AE1B2EB46215F158076EBA4074BAA5D0047393EB7C9292D8CE8EB6A438FBF37F9C7C598F4E581289A6AEBAA78EF1869648C16109A0E6D0AE7BA06F6A929DCECEAEA6DF7F1F7ADDD847E5992ECC0CE83CDFB0EA7CF848A441BD9303F40B682D12D1DDB6D7F622976D8CA212B3ED51D6E351F5C27ED793D89FFFDEE180CC0CE83CDFB0EA7CED51D6E351F5C27E5D45EDC7AD6DBFF89518991EC0DA0D875D45EDC7AD6DBFF8123CD9792C63C2E4461C0E1E3F71C66D75829BF942727DEE2046484AF26FA1537127080FC9141B0839C17C833023191D75829BF942727DEE2046484AF26FA153E8B39C0EBDC175AE9016CA5407E8BF98ED317669CE9E869F7BFB3DC853FAE73234A320153B07A1B09BBD3752B67863B37B894CFC61CBBFAA5D45EDC7AD6DBFF823E7557E508D233E04A53A4B4D1AA206A92617E41D3D665355DC12A20E0D59B25AFEB1C4DFE12872165DF412C3C8859BED9CFCB98E351D8F183B0D56A8788A6B83CDCD0B4B1ECACE2C3FBC1D79AF7D34BE2786D88B89C0D83FAC41C9560730C8812E2801EF42A2A039F0DCBF5AF2FA458B70F30F11D27F1F5D45EDC7AD6DBFF8268F813DD7B89C036AACDEDE98E833E1069C403870BA955F548DA695922E54435CE2D5789B32FE3B6719B574EE49DB3002FD37A186851C2EE96F335E9174803370F83EE2B4040B8D2582930B10D20F3BC971B612658964F82582930B10D20F3B89B7378D26EEBACD4594D8BA8CB3754AD19AEA6911DE9FB96E49E1462F41980BE6E511C353FC21FBF5B0AC67CA6D70277E3A694C90B35E2FF5F357D017A1C731558F29E44D5F7C38|4122AA9D6AE09322647483B614F78498E2CFA299134C85F105732CA8CFD69E1D828E912F684A42B45E547EB278097BC15889267A7657F2A4CF515829BDAA61FC51EA5F66FDCF3B64A284F1C1DA8921C2DB7F6E4AB13752279D1CB30AD54F152E72ABED178282307317EB2E0A7C53A1778CE3A471036F324B8DC6B19CC96F5D3918279CE0F670861B16F7CAEFCAC6BE833264EC5B00BFA8715EF89A1F606A642900CCB89795492299F02782D76FC7F78CC4EE5A6C99051113F8BAE114F7CBC60B973D21E9FB3AFBE4B8CC2EF9FF100137F36B06CD7197A24AFF91C305B6101D86174EA296BF5F0687BA02FE731A0F76E893EC38F6FADB73EB1FDB81E1963672E7";
                SPE.Api.PagoEfectivo.PublicPathContraparte = ConfigurationManager.AppSettings["pathPublicKeyContraparte"];
                SPE.Api.PagoEfectivo.PrivatePath = ConfigurationManager.AppSettings["pathPrivateKey"];

                postvariable = SPE.Api.PagoEfectivo.DesenciptarTexto(postvariable);

                int estado = 0;
                string CodTrans = "";

                XmlDocument nlSolpago = new XmlDocument();
                nlSolpago.InnerXml = postvariable;

                XmlNode nlSolpago2 = nlSolpago.SelectSingleNode("ConfirSolPago");

                XmlNode nlCodTrans = nlSolpago2.SelectSingleNode("CodTrans");
                string valueId = nlCodTrans.InnerText;
                CodTrans = valueId;

                XmlNode nlEstado = nlSolpago2.SelectSingleNode("Estado");
                string valueEstado = nlEstado.InnerText;
                estado = Convert.ToInt32(valueEstado);

                XmlNode nlSolpago3 = nlSolpago2.SelectSingleNode("CIP");
                XmlNode nlCip = nlSolpago3.SelectSingleNode("NumeroOrdenPago");
                ViewState["CIP"] = nlCip.InnerText;

                switch (estado)
                {
                    case 592: CambioEstado(EstadoPedido.Pedido); break;  //El banco extorno la transaccion - debe regresar a pendiente de pago
                    case 593: CambioEstado(EstadoPedido.Pagado); break; //Se realizo el pago de la transacción
                    case 595: CambioEstado(EstadoPedido.Expirado); break; //Expiró la transacción despues de generada como CIP
                }
            }
        }

        private void CambioEstado(EstadoPedido estado)
        {
            PedidoBC objPedidoBC = new PedidoBC();
            MailBC objMailBC = new MailBC();

            try
            {
                PedidoBE objPedidoBE = objPedidoBC.Get_Pedido_Completo_Cip(ViewState["CIP"].ToString());
                objPedidoBC.Update_Pedido_Estado_Cip(ViewState["CIP"].ToString(), (int)estado);
                objMailBC.Cambio_Estado_Pedido(objPedidoBE, estado);
            }
            catch (Exception)
            {

                throw;
            }
        }

        //private void ExpirarTransaccion()
        //{
        //    PedidoBC objPedidoBC = new PedidoBC();
        //    MailBC objMailBC = new MailBC();

        //    try
        //    {
        //        PedidoBE objPedidoBE = objPedidoBC.Get_Pedido_Completo_Cip(ViewState["CIP"].ToString());
        //        objPedidoBC.Update_Pedido_Estado_Cip(ViewState["CIP"].ToString(), (int)EstadoPedido.Expirado);
        //        objMailBC.Compra_Pagada(objPedidoBE);
        //    }
        //    catch (Exception)
        //    {

        //        throw;
        //    }
        //}



        //private void PagarTransaccion()
        //{
        //    PedidoBC objPedidoBC = new PedidoBC();
        //    MailBC objMailBC = new MailBC();

        //    try
        //    {
        //        PedidoBE objPedidoBE = objPedidoBC.Get_Pedido_Completo_Cip(ViewState["CIP"].ToString());
        //        objPedidoBC.Update_Pedido_Estado_Cip(ViewState["CIP"].ToString(), (int)EstadoPedido.Pagado);
        //        objMailBC.Cambio_Estado_Pedido(objPedidoBE);
        //    }
        //    catch (Exception)
        //    {

        //        throw;
        //    }
        //}

        //private void ExtornarTransaccion()
        //{
        //    PedidoBC objPedidoBC = new PedidoBC();

        //    try
        //    {
        //        objPedidoBC.Update_Pedido_Estado_Cip(ViewState["CIP"].ToString(), (int)EstadoPedido.Pedido);
        //    }
        //    catch (Exception)
        //    {

        //        throw;
        //    }
        //}
    }
}